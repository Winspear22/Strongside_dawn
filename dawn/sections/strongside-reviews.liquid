{% schema %}
{
  "name": "Strongside Reviews",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "AVIS CLIENTS"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "CE QUE NOS CLIENTS DISENT"
    },
    {
      "type": "color",
      "id": "bg_start",
      "label": "Gradient Start",
      "default": "#171717"
    },
    {
      "type": "color",
      "id": "bg_end",
      "label": "Gradient End",
      "default": "#000000"
    }
  ],
  "blocks": [
    {
      "type": "@app"
    }
  ],
  "presets": [
    {
      "name": "Strongside Reviews",
      "settings": {}
    }
  ]
}
{% endschema %}

<style>
  #shopify-section-{{ section.id }} {
    background: linear-gradient(to bottom, {{ section.settings.bg_start }}, {{ section.settings.bg_end }});
    padding: 4rem 1.5rem;
    color: white;
  }
  @media (min-width: 1024px) {
    #shopify-section-{{ section.id }} { padding: 6rem 1.5rem; }
  }

  /* CONTAINER */
  /* Container widening (approx +20% from 110rem) */
  .ss-reviews-container {
      width: 100%;
      max-width: 130rem; /* WIDENED to ~2100px */
      margin: 0 auto;
      padding: 0 2rem;
  }

  /* HEADER */
  #shopify-section-{{ section.id }} .ss-reviews-header {
    text-align: center;
    margin-bottom: 2.5rem;
  }
  #shopify-section-{{ section.id }} .ss-reviews-subtitle {
    color: #ff2222 !important; /* brand-accent */
    font-size: 0.875rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    display: block;
    margin-bottom: 0.5rem;
    font-family: ui-sans-serif, system-ui, sans-serif;
  }
  #shopify-section-{{ section.id }} .ss-reviews-title {
    font-family: 'Inter', system-ui, sans-serif;
    font-size: 3rem;
    font-weight: 900;
    font-style: italic;
    text-transform: uppercase;
    color: white !important; /* Title always white on dark section background */
    line-height: 1;
    margin: 0;
  }
  @media (min-width: 768px) {
    #shopify-section-{{ section.id }} .ss-reviews-title { font-size: 4rem; }
  }

  /* ==================================================================
     DEFAULT (DARK MODE) STYLES
     Card blends into the dark theme, White Text, Glassy Look
     ================================================================== */

  /* APP WIDGET WRAPPER - DARK MODE SKELETON */
  .ss-reviews-widget-wrapper {
    background-color: rgba(255, 255, 255, 0.05); /* Glassy Dark */
    border: 1px solid rgba(255, 255, 255, 0.1);    /* Subtle Border */
    border-radius: 2rem !important;
    padding: 2.5rem;
    overflow: hidden;
    position: relative;
    /* REDUCED Z-INDEX TO PREVENT NAVBAR OVERLAP */
    z-index: 1;
  }

  /* Dark Mode Text Colors (White/Gray) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg {
    color: white !important;
    font-family: inherit !important;
    user-select: text !important;
    -webkit-user-select: text !important;
    /* Removed z-index to enforce stacking from wrapper */
    position: relative !important;
  }
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg__title {
    color: white !important;
    font-size: 1.1rem !important;
    font-weight: 700 !important;
  }
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg__body,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__content,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__body p {
    color: #e5e7eb !important; /* Gray-200 */
    font-size: 1rem !important;
    line-height: 1.6 !important;
  }
  /* Metadata (Name/Date) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__reviewer-name-wrapper,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__timestamp {
    color: #9ca3af !important; /* Gray-400 */
  }
  /* Stars */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star { color: #ffd700 !important; }
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star.jdgm--on { color: #ffd700 !important; }
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star.jdgm--off { color: rgba(255,255,255,0.2) !important; }

  /* Inputs (Dark Mode) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper input,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper textarea {
    background-color: rgba(255, 255, 255, 0.05) !important;
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    color: white !important;
  }

  /* Pagination */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-paginate__page {
    color: white !important;
    border-color: rgba(255, 255, 255, 0.1) !important;
  }

  /* ==================================================================
     LIGHT MODE OVERRIDES - THE "WHITE CARD" DESIGN
     Applied ONLY when html.strongside-light is present
     ================================================================== */

  html.strongside-light .ss-reviews-widget-wrapper {
    background-color: #ffffff !important; /* Force White Block */
    border: 1px solid #ff2222 !important; /* Red Border */
    box-shadow: 0 0 20px rgba(255, 34, 34, 0.25); /* Red Glow */
  }

  /* Light Mode Text Colors (Dark/Dark Gray) */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg__title {
    color: #111827 !important; /* Dark Text */
  }

  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev-widg__body,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__content,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__body p {
    color: #374151 !important; /* Dark Gray */
  }

  /* Light Mode Stars Color */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star.jdgm--on {
    color: #FACC15 !important;
    fill: #FACC15 !important;
    stroke: #FACC15 !important;
  }

  /* Light Mode Stars Off Color */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-star.jdgm--off {
    color: #e5e7eb !important; /* Light Gray */
  }

  /* Light Mode Metadata */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__reviewer-name-wrapper,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__timestamp {
    color: #6b7280 !important; /* Gray-500 */
  }

  /* Light Mode Inputs */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper input,
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper textarea {
    background-color: #f9fafb !important;
    border-color: #d1d5db !important;
    color: #111827 !important;
  }

  /* Light Mode Pagination */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-paginate__page {
    color: #374151 !important;
    border-color: #e5e7eb !important;
  }


  /* Separator */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
  }
  /* Separator Light Mode */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__header {
    border-bottom: 1px solid #e5e7eb !important;
  }

  /* Buttons (Common) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-write-rev-link,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-form-submit-btn {
    background-color: #ff2222 !important;
    border-color: #ff2222 !important;
    color: white !important;
    border-radius: 9999px !important;
    text-transform: uppercase !important;
    font-weight: 700 !important;
    padding: 0.75rem 2rem !important;
    display: inline-block !important;
  }
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-write-rev-link:hover,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-form-submit-btn:hover {
    background-color: #d90000 !important;
  }

  /* Verified Badge (Common) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-rev__icon:after {
    background-color: #ff2222 !important;
  }

  /* Pagination Active (Common) */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-paginate__page.jdgm-curt {
    color: #ff2222 !important;
    border-color: #ff2222 !important;
  }

  /* ============================================
     SOLUTION FINALE : CACHER LE TRI, CENTRER ÉCRIRE
     ============================================ */

  /* CACHER le dropdown de tri - cause tous les problèmes */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown-wrapper,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper select.jdgm-sort-dropdown {
    display: none !important;
    visibility: hidden !important;
  }

  /* TOUT LE HEADER centré */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-header,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-subtab,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-actions {
    display: block !important;
    text-align: center !important;
    width: 100% !important;
    float: none !important;
    clear: both !important;
  }

  /* Summary centrée */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-summary {
    display: block !important;
    text-align: center !important;
    margin-bottom: 20px !important;
  }

  /* Bouton ÉCRIRE - on enlève TOUT float et on le met inline-block */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-write-rev-link {
    display: inline-block !important;
    float: none !important;
    position: static !important;
    /* PAS de margin auto car c'est inline-block, le parent fait le centrage */
  }

  /* NUCLEAR: Hide arrows */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-subtab:after,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown:after,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-subtab:before,
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown:before {
    display: none !important;
    content: none !important;
    width: 0 !important;
    height: 0 !important;
  }

  /* DROPDOWN OPTIONS (The white box)
     Note: Styling <option> is limited by browsers, but we try standard overrides */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown option {
    background-color: #171717 !important;
    color: white !important;
  }

  /* Light Mode Options */
  html.strongside-light #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown option {
    background-color: white !important;
    color: black !important;
  }

  /* Hide the old CSS arrow if Judge.me inserts one separately */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-sort-dropdown-arrow {
    display: none !important;
  }

  /* Clear floats to prevent layout breakage */
  html body #shopify-section-{{ section.id }} .ss-reviews-widget-wrapper .jdgm-header:after {
    content: "";
    display: table;
    clear: both;
  }

  /* LIGHT MODE OVERRIDE - SECTION BACKGROUND */
  html.strongside-light .ss-reviews-container {
    background-color: transparent !important;
  }
  /* No title override needed as section BG is dark in both modes, so title stays white. */
</style>

<div class="ss-reviews-container" id="customer-reviews">
  <!-- HEADER -->
  <div class="ss-reviews-header">
    <span class="ss-reviews-subtitle">{{ 'strongside.reviews.subtitle' | t }}</span>
    <h2 class="ss-reviews-title">{{ 'strongside.reviews.title' | t }}</h2>
  </div>

  <!-- APP BLOCK WRAPPER -->
  <div class="ss-reviews-widget-wrapper">
    {%- for block in section.blocks -%}
      {% render block %}
    {%- endfor -%}

    {%- if section.blocks.size == 0 -%}
      <div style="text-align:center; padding: 2rem; color: #9ca3af;">
        <p>Ajoutez le bloc "Judge.me Reviews" ici via l'éditeur.</p>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
  window.addEventListener('load', function () {
    // ============================================
    // TRANSLATION INJECTION
    // ============================================
    const translations = {
      writeReview: "{{ 'strongside.reviews.writeReview' | t }}",
      reviewsCount: "{{ 'strongside.reviews.reviewsCount' | t }}",
      beFirst: "{{ 'strongside.reviews.beFirst' | t }}",
      noReviews: "{{ 'strongside.reviews.noReviews' | t }}",
      cancel: "{{ 'strongside.reviews.cancel' | t }}",
      submit: "{{ 'strongside.reviews.submitReview' | t }}",
      title: "{{ 'strongside.reviews.title' | t }}",
      reviewWord: "{{ 'strongside.reviews.reviewWord' | t | default: 'reviews' }}",
    };

    function translateWidget() {
      // Translate "Write a Review" button
      const writeBtns = document.querySelectorAll('.jdgm-write-rev-link');
      writeBtns.forEach((btn) => {
        btn.innerText = translations.writeReview;
      });

      // Translate the widget header title (e.g., "Customer Reviews" -> "Avis Clients")
      const headerTitles = document.querySelectorAll('.jdgm-rev-widg__title');
      headerTitles.forEach((title) => {
        title.innerText = translations.title;
      });

      // Translate review count text (e.g., "10 reviews" -> "10 avis")
      const reviewCounts = document.querySelectorAll('.jdgm-rev-widg__summary-text');
      reviewCounts.forEach((el) => {
        // Extract the number and replace the word
        const text = el.innerText;
        const match = text.match(/(\d+)/);
        if (match) {
          el.innerText = match[1] + ' ' + translations.reviewWord;
        }
      });

      // Also check for badge text
      const badgeTexts = document.querySelectorAll('.jdgm-prev-badge__text');
      badgeTexts.forEach((txt) => {
        const match = txt.innerText.match(/(\d+)/);
        if (match) {
          txt.innerText = match[1] + ' ' + translations.reviewWord;
        }
      });

      // Submit button in form
      const submitBtns = document.querySelectorAll('.jdgm-form-submit-btn');
      submitBtns.forEach((btn) => {
        btn.value = translations.submit; // for input type=submit
        btn.innerText = translations.submit; // for button
      });

      // Cancel button in form
      const cancelBtns = document.querySelectorAll('.jdgm-cancel-rev-link');
      cancelBtns.forEach((btn) => {
        btn.innerText = translations.cancel;
      });
    }

    // Use MutationObserver to detect when judge.me renders
    const observer = new MutationObserver((mutations) => {
      let shouldTranslate = false;
      mutations.forEach((mutation) => {
        if (mutation.addedNodes.length) {
          shouldTranslate = true;
        }
      });
      if (shouldTranslate) {
        translateWidget();
        // Also try button reorganization
        if (typeof reorganizeButtons === 'function') reorganizeButtons();
      }
    });

    const widgetContainer = document.querySelector('.ss-reviews-widget-wrapper');
    if (widgetContainer) {
      observer.observe(widgetContainer, { childList: true, subtree: true });
      // Initial try
      translateWidget();
    } else {
      // Fallback if wrapper not found immediately
      const interval = setInterval(() => {
        const wc = document.querySelector('.ss-reviews-widget-wrapper');
        if (wc) {
          observer.observe(wc, { childList: true, subtree: true });
          translateWidget();
          clearInterval(interval);
        }
      }, 500);
    }

    // Safety check with interval still, just in case DOM changes don't trigger what we expect
    setInterval(translateWidget, 2000);

    // ============================================
    // JAVASCRIPT DOM REORGANIZATION FOR BUTTONS
    // CSS alone fails because Judge.me loads async
    // ============================================

    function reorganizeButtons() {
      const header = document.querySelector('.ss-reviews-widget-wrapper .jdgm-header');
      if (!header) return false;

      const writeBtn = header.querySelector('.jdgm-write-rev-link');
      const sortDropdown = header.querySelector('.jdgm-sort-dropdown');

      if (!writeBtn || !sortDropdown) return false;

      // Check if already reorganized
      if (header.querySelector('.ss-button-row')) return true;

      // Create a new flex container for the buttons
      const buttonRow = document.createElement('div');
      buttonRow.className = 'ss-button-row';
      buttonRow.style.cssText = `
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        width: 100% !important;
        margin-top: 20px !important;
        padding: 0 10px !important;
      `;

      // Clone and style the sort dropdown wrapper
      const sortWrapper = sortDropdown.parentElement || sortDropdown;
      const sortClone = sortWrapper.cloneNode(true);
      sortClone.style.cssText = `
        order: 1 !important;
        margin-right: auto !important;
      `;

      // Clone and style the write button
      const writeClone = writeBtn.cloneNode(true);
      writeClone.style.cssText = `
        order: 2 !important;
        margin-left: auto !important;
      `;

      // Add to the new row
      buttonRow.appendChild(sortClone);
      buttonRow.appendChild(writeClone);

      // Hide originals
      if (sortWrapper !== sortDropdown) sortWrapper.style.display = 'none';
      sortDropdown.style.display = 'none';
      writeBtn.style.display = 'none';

      // Add the new row to the header
      header.appendChild(buttonRow);

      console.log('[Strongside] Buttons reorganized successfully!');
      return true;
    }

    // Try multiple times as Judge.me loads async
    let attempts = 0;
    const maxAttempts = 20;
    const reorganizeInterval = setInterval(function () {
      attempts++;
      if (reorganizeButtons() || attempts >= maxAttempts) {
        clearInterval(reorganizeInterval);
      }
    }, 500);

    // ============================================
    // NUCLEAR CSS INJECTION
    // ============================================
    setTimeout(function () {
      const style = document.createElement('style');
      style.innerHTML = `
        /* Default Dark Mode Stars */
        .jdgm-star { color: #ffd700 !important; }
        
        /* Light Mode Stars Override */
        html.strongside-light .jdgm-star { color: #FACC15 !important; }
        html.strongside-light .jdgm-star.jdgm--on { color: #FACC15 !important; }
        html.strongside-light .jdgm-star.jdgm--off { color: #e5e7eb !important; }

        .jdgm-write-rev-link, .jdgm-form-submit-btn { background-color: #ff2222 !important; border-color: #ff2222 !important; }
        .jdgm-rev__icon:after { background-color: #ff2222 !important; }
        .jdgm-rev-widg__title { color: white !important; font-size: 1.1rem !important; }
        .jdgm-rev-widg__body, .jdgm-rev__content, .jdgm-rev__body p { color: #e5e7eb !important; }
        .jdgm-rev__reviewer-name-wrapper, .jdgm-rev__timestamp { color: #9ca3af !important; }
        
        /* Style the new button row */
        .ss-button-row .jdgm-sort-dropdown {
          color: white !important;
          background-color: rgba(255, 255, 255, 0.1) !important;
          border: 1px solid rgba(255, 255, 255, 0.2) !important;
          border-radius: 6px !important;
          min-width: 220px !important;
          height: 40px !important;
          padding: 0 15px !important;
          appearance: none !important;
          cursor: pointer !important;
        }
        .strongside-reviews-badge {
          display:flex; 
          align-items:center; 
          gap:0.5rem; 
          background:rgba(255,255,255,0.05); 
          padding:0.8rem 1.6rem; 
          border-radius:9999px; 
          border:1px solid rgba(255,255,255,0.1); 
          cursor:pointer; 
          margin-bottom:2.4rem; 
          transition:all 0.2s;
        }
      `;
      document.body.appendChild(style);
    }, 1000);

    // ============================================
    // CLEANUP DROPDOWN (Remove Photos/Videos options)
    // ============================================
    const cleanupInterval = setInterval(function () {
      const dropdowns = document.querySelectorAll('.jdgm-sort-dropdown');
      dropdowns.forEach((dropdown) => {
        const options = dropdown.querySelectorAll('option');
        options.forEach((opt) => {
          // Normalize text to remove accents (e.g. "Vidéos" -> "Videos")
          const txt = opt.innerText
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '');
          const val = opt.value.toLowerCase();

          // Remove options mentioning photos, videos, or media
          if (txt.includes('photo') || txt.includes('video') || txt.includes('picture') || val.includes('media')) {
            opt.remove();
          }
        });
      });
    }, 500);

    // Stop the interval after 10 seconds to save performance
    setTimeout(() => clearInterval(cleanupInterval), 10000);
  });
</script>
